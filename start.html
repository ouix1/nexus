<!DOCTYPE html>
<!-- Defines this file as an HTML5 document -->

<html lang="en">
<!-- Sets the language to English -->

<head>
  <meta charset="UTF-8">
  <!-- Tells the browser to use UTF-8 encoding so characters display correctly -->

  <title>LIDAR 3D Viewer</title>
  <!-- Title shown in the browser tab -->

  <style>
    body { margin: 0; overflow: hidden; }
    /* Removes default white margins and hides scrollbars,
       letting THREE.js use the entire screen */
  </style>

  <!-- BOOTSTRAP ICONS (for icons in navbar) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- BOOTSTRAP CSS (page styling & layout) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- These 3 lines incorrectly link to .html as CSS, but keeping because you want comments -->
  <link rel="stylesheet" href="contact.html">  <!-- Not a CSS file but included as you wrote -->
  <link rel="stylesheet" href="gallery.html">  <!-- Same here -->
  <link rel="stylesheet" href="style.css"> <!-- Your main custom CSS -->
  <link rel="stylesheet" href="start.html">      <!-- Not CSS but included anyway -->
</head>

<body>
<!-- Everything visible on the webpage goes inside <body> -->

<!-- =============================================================
     NAVIGATION BAR (top menu)
============================================================== -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <!-- Bootstrap dark-themed navbar that sticks to the top -->

  <div class="container-fluid">
    <!-- Makes navbar content stretch nicely -->

    <a class="navbar-brand fw-bold" href="home.html">
      ne<span style="color: #0d6efd">x</span>us
    </a>
    <!-- Website logo -->

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
      data-bs-target="#navbarSupportedContent">
      <!-- Hamburger menu for mobile view -->
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
      <!-- Collapsible menu container -->

      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <!-- Navigation links aligned to the right -->

        <li class="nav-item">
          <a class="nav-link" href="home.html">Home</a>
          <!-- Link to home page -->
        </li>

        <li class="nav-item">
          <a class="nav-link" href="gallery.html">gallery</a>
          <!-- Link to gallery page -->
        </li>

        <li class="nav-item">
          <a class="nav-link" href="Our_team.html">Our Team</a>
          <!-- Link to "Our Team" page -->
        </li>

        <li>
          <button type="button" class="nav-link btn btn-dark fw-bold"
            data-bs-toggle="modal" data-bs-target="#contactModal">
            Contact
          </button>
          <!-- Opens contact modal -->
        </li>

        <li class="nav-item" id="startdiv">
          <a class="nav-link active" href="start.html">Lidar_scanner</a>
          <!-- Highlights current page -->
        </li>

      </ul>
    </div>
  </div>
</nav>


<style>
    .scanner-panel {
        position: absolute;
        top: 120px;
        z-index: 100;
        width: 95%;
        max-width: 350px;
        /* Mobile Default: Centered */
        left: 50%;
        transform: translateX(-50%);
    }

    /* Desktop/Tablet: Move to left corner */
    @media (min-width: 768px) {
        .scanner-panel {
            left: 20px;
            transform: none;
        }
    }
</style>

<div class="scanner-panel bg-dark p-4 rounded-4 shadow-lg border border-secondary text-white">
    
    <h5 class="border-bottom border-secondary pb-2 mb-4 text-uppercase small tracking-widest text-center">IMU 3D Scanner</h5>
    
    <div class="row text-center mb-4">
        <div class="col-4">
            <div class="text-secondary small">YAW</div>
            <div id="valA" class="h3 fw-bold text-info">0°</div>
        </div>
        <div class="col-4">
            <div class="text-secondary small">PITCH</div>
            <div id="valB" class="h3 fw-bold text-warning">0°</div>
        </div>
        <div class="col-4">
            <div class="text-secondary small">ROLL</div>
            <div id="valC" class="h3 fw-bold text-danger">0°</div>
        </div>
    </div>

    <div class="text-center mb-4 py-3 bg-black bg-opacity-25 rounded-3">
        <span class="text-secondary">LIDAR: </span>
        <span id="valDist" class="h3 text-success fw-bold">0cm</span>
    </div>
    
    <button id="toggleBtn" onclick="toggleScan()" class="btn btn-lg btn-primary w-100 mb-3 py-3 fw-bold shadow">
        START SCAN
    </button>

    <button onclick="resetScan()" class="btn btn-md btn-outline-light w-100 mb-3">Reset Horizon</button>

    <div class="form-check form-switch d-flex justify-content-center align-items-center gap-2 mt-2">
        <input class="form-check-input" type="checkbox" id="autoFollow" checked style="width: 3em; height: 1.5em;">
        <label class="form-check-label small text-secondary" for="autoFollow">Auto-Adjust Camera</label>
    </div>
</div>

<style> .tiny { font-size: 0.6rem; } </style>

<!-- =============================================================
     THREE.JS LIBRARY (3D rendering)
============================================================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<!-- =============================================================
     FIREBASE LIBRARIES (Realtime DB + Auth compat version 8)
============================================================== -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// ======================================================================
// 1. FIREBASE CONFIGURATION
// ======================================================================

// Your Firebase project settings — required to connect to your database
const firebaseConfig = {
  apiKey: "AIzaSyDr5USKStzLZ6OQCfTBbZBmqihhbpBNmCY",
  authDomain: "dsc-dba80.firebaseapp.com",
  projectId: "dsc-dba80",
  storageBucket: "dsc-dba80.firebasestorage.app",
  messagingSenderId: "631849635750",
  appId: "1:631849635750:web:6a43bd500ffef3cced0967",
  measurementId: "G-T7H2VFC56J",
  databaseURL: "https://dsc-dba80-default-rtdb.firebaseio.com/"
};

// Start Firebase using the above config
firebase.initializeApp(firebaseConfig);

// Print Firebase object to the console to confirm it's running
console.log("Firebase:", firebase);


// ======================================================================
// 2. THREE.JS — CREATE A 3D ENVIRONMENT
// ======================================================================

console.log("THREE:", THREE);

// Create a 3D "world" where objects will exist
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);   // Dark grey background

// Create a perspective camera (like the human eye)
const camera = new THREE.PerspectiveCamera(
  75,                                          // field of view (degrees)
  window.innerWidth / window.innerHeight,      // aspect ratio
  0.1,                                         // near clipping distance
  1000                                         // far clipping distance
);

// Move the camera back so we can see the 3D space
camera.position.set(3, 3, 3);

// Create the WebGL renderer (draws the 3D graphics)
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);

// Add the 3D canvas to the page
document.body.appendChild(renderer.domElement);

// ==========================================
// 3. INITIALIZE CONTROLS HERE (The Fix)
// ==========================================
controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; 
controls.dampingFactor = 0.05;

// Create a grid floor for visual reference (10x10)
const grid = new THREE.GridHelper(10, 10);
// Move it DOWN 2 meters
grid.position.y = -2;
scene.add(grid);

// Add a light so objects are visible
const light = new THREE.PointLight(0xffffff, 1);
light.position.set(5, 5, 5);
scene.add(light);


// ======================================================================
// 3. FUNCTION TO CREATE A POINT (DOT) IN 3D
// ======================================================================
let boundingBox = new THREE.Box3();
// --- 1. Global State Variables ---
let yaw = 0, pitch = 0, roll = 0;
let lastTimestamp = Date.now();
let allPoints = []; // To store points for exporting later

function createDot(x, y, z) {
    // 1. SAFETY CHECK: If any coordinate is NaN or undefined, STOP.
    if (isNaN(x) || isNaN(y) || isNaN(z)) return;

    // 2. DISTANCE THRESHOLD: Don't add dots if they are too close (3cm)
    if (allPoints.length > 0) {
        const last = allPoints[allPoints.length - 1];
        const d = Math.sqrt((x - last.x)**2 + (y - last.y)**2 + (z - last.z)**2);
        if (d < 0.03) return; 
    }

    // 3. COLOR LOGIC: Map Height (Y) to Color
    const pointColor = new THREE.Color();
    // Adjust 'y / 2' based on your room height (0 = blue, 1 = red)
    const hue = Math.abs(y % 1); 
    pointColor.setHSL(hue, 1, 0.5);

    // 4. CREATE MESH: New material for EVERY dot is required for color changes
    const geometry = new THREE.SphereGeometry(0.02, 8, 8);
    const material = new THREE.MeshBasicMaterial({ color: pointColor });
    const sphere = new THREE.Mesh(geometry, material);
    
    sphere.position.set(x, y, z);
    scene.add(sphere);

    // 5. UPDATE DATA & CAMERA
    const newVec = new THREE.Vector3(x, y, z);
    allPoints.push(newVec);
    
    // Only adjust camera if the checkbox is checked
    if (document.getElementById("autoFollow").checked) {
        expandCameraToFit(newVec);
    }
}

function expandCameraToFit(newPoint) {
    // 1. Expand the bounding box to include the new point
    boundingBox.expandByPoint(newPoint);

    // 2. Get the center point of the entire scan
    const center = new THREE.Vector3();
    boundingBox.getCenter(center);

    // 3. Update the OrbitControls target
    // We check isNaN again just to be 100% safe from black screens
    if (controls && !isNaN(center.x)) {
        // .copy() is an instant jump, .lerp() is a smooth slide
        controls.target.lerp(center, 0.1); 
    }
}
// Function to Reset the Scan
function resetScan() {
    // 1. Reset Data
    allPoints = [];
    boundingBox.makeEmpty();
    yaw = 0; pitch = 0; roll = 0;

    // 2. Clear Scene (Looping backwards is the key)
    for (let i = scene.children.length - 1; i >= 0; i--) {
        const obj = scene.children[i];
        // Don't delete the grid or the camera!
        if (obj.type === "Mesh" && obj !== grid) {
            scene.remove(obj);
            if(obj.geometry) obj.geometry.dispose();
            if(obj.material) obj.material.dispose();
        }
    }

    // 3. Reset Camera Position to a safe distance
    camera.position.set(0, 2, 5);
    controls.target.set(0, 0, 0);
    controls.update();
    
    console.log("Scan Cleared and Camera Reset");
}

// ======================================================================
// 4. READ LIDAR DATA FROM FIREBASE AND DRAW DOTS
// ======================================================================


// Filter constant: 0.98 trusts the Gyro for fast motion, 
// 0.02 trusts Accelerometer for the gravity "truth".
const ALPHA = 0.98; 

// --- 2. Firebase Listener ---
firebase.database().ref("/fromAltera").on("value", snapshot => {
    const data = snapshot.val();
    if (!data || !data.gyro || !data.accel || !data.lidar) return;

    // Time calculation for integration
    const now = Date.now();
    const dt = (now - lastTimestamp) / 1000;
    lastTimestamp = now;

    // --- 3. Sensor Fusion (Complementary Filter) ---
    
    // Calculate Pitch and Roll from Accelerometer (Gravity Vector)
    // Pitch: Tilt forward/backward
    const accPitch = Math.atan2(data.accel.y, data.accel.z) * (180 / Math.PI);
    // Roll: Tilt side-to-side
    const accRoll = Math.atan2(-data.accel.x, Math.sqrt(data.accel.y**2 + data.accel.z**2)) * (180 / Math.PI);

    // Apply Filter: NewAngle = (0.98 * (Current + GyroDelta)) + (0.02 * AccelTruth)
    pitch = ALPHA * (pitch + data.gyro.x * dt) + (1 - ALPHA) * accPitch;
    roll = ALPHA * (roll + data.gyro.z * dt) + (1 - ALPHA) * accRoll;
    
    // Yaw: Pure integration (requires a Magnetometer for "truth", which we don't have here)
    yaw += data.gyro.y * dt;

    // --- 4. 3D Coordinate Mapping ---
    
    const distCm = Number(data.lidar.dist);
    // Ignore errors (-1) or out-of-range (>12m)
    if (distCm <= 0 || distCm > 1200) return;

    const radius = distCm / 100; // Convert to meters

    // Step A: Create a vector pointing straight ahead (Z-axis)
    // We use -radius because in Three.js, "forward" is usually negative Z
    let point = new THREE.Vector3(0, 0, -radius);

    // Step B: Create a Rotation Matrix (Euler) based on our IMU angles
    // Order 'YXZ' is standard for "FPS camera" style movement
    const euler = new THREE.Euler(
        pitch * (Math.PI / 180),
        yaw * (Math.PI / 180),
        roll * (Math.PI / 180),
        'YXZ'
    );

    // Step C: Apply the rotation to our distance vector
    point.applyEuler(euler);

    // --- 5. Rendering & UI ---
    
    // Add point to scene
    createDot(point.x, point.y, point.z);
    
    // Update the Bootstrap UI numbers
    document.getElementById("valA").innerText = Math.round(yaw) + "°";
    document.getElementById("valB").innerText = Math.round(pitch) + "°";
    document.getElementById("valC").innerText = Math.round(roll) + "°";
    document.getElementById("valDist").innerText = distCm + "cm";
    expandCameraToFit(point);
    //centerCameraOnPoints(allPoints);
});

// Auto camera centering: averages all points
function centerCameraOnPoints(points) {
  const avg = { x: 0, y: 0, z: 0 };
  let count = points.length;

  points.forEach(p => {
    avg.x += p.x;
    avg.y += p.y;
    avg.z += p.z;
  });

  // Compute average
  avg.x /= count;
  avg.y /= count;
  avg.z /= count;

  // Reposition camera
  camera.position.set(avg.x + 5, avg.y + 5, avg.z + 5);
  camera.lookAt(avg.x, avg.y, avg.z);
}


// ======================================================================
// 5. ANIMATION LOOP — REDRAWS THE SCENE 60FPS
// ======================================================================

// Runs continuously to update the graphics
function animate() {
    requestAnimationFrame(animate);

    // This makes the 'lerp' and 'target' changes actually happen on screen
    if (controls) {
        controls.update(); 
    }

    renderer.render(scene, camera);
}
// Make sure this is called once to start the loop
animate();

let isScanning = false;
// Assumes firebase has been initialized earlier in your code
const database = firebase.database(); 

function toggleScan() {
    const btn = document.getElementById('toggleBtn');
    const targetRef = database.ref('toAltera');

    if (!isScanning) {
        // START: Send 0 to Firebase
        targetRef.set(0).then(() => {
            isScanning = true;
            btn.innerText = "STOP SCAN";
            btn.classList.replace('btn-primary', 'btn-danger'); // Change color to red
        }).catch(err => console.error("Firebase Set Error:", err));
        
    } else {
        // STOP: Send 2 to Firebase
        targetRef.set(2).then(() => {
            isScanning = false;
            btn.innerText = "START SCAN";
            btn.classList.replace('btn-danger', 'btn-primary'); // Change color back to blue
        }).catch(err => console.error("Firebase Set Error:", err));
    }
}
</script>

</body>
</html>
